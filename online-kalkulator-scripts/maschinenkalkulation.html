<script>

var CalculationMapping = {
    "Personalkosten": "fieldname11",
    "NebenzeitenPersonal": {id: "fieldname23", factor: 0.01 },
    "NebenzeitenGrundmaschine": { id: "fieldname50", factor: 0.01 },
    "OrganisationsUnternehmenskosten": {id: "fieldname20", factor: 0.01},
    "Wagnis": {id: "fieldname28", factor: 0.01},
    "LeistungsbereichMin": "fieldname55",
    "LeistungsbereichMax": "fieldname56",
};

if (typeof Mapping == "undefined") {
    Mapping = {};
}
Mapping["Calculation"] = CalculationMapping;

function getNamedField(currForm, name) {
    for (const[mappingName, mapValues]of Object.entries(Mapping)) {
        if(name in mapValues){
            var factor;
            var fieldId;
            var fieldIdOrObj = mapValues[name];
            if(typeof fieldIdOrObj === "string"){
                fieldId = fieldIdOrObj;
            }
            else{
                if("id" in fieldIdOrObj) fieldId = fieldIdOrObj["id"];
                if("factor" in fieldIdOrObj) factor = fieldIdOrObj["factor"];
            }

            if (fieldId) {
                var targetField = getField(fieldId, currForm);
                return [targetField, factor];
            }
        }
    }
    //no match found
    return [undefined, undefined];
}

function setNamedFieldValue(currForm, name, value) {
    var [field, factor] = getNamedField(currForm, name);
    if (field) {
        if(factor){
            field.setVal(Number((value/factor).toFixed(6)));
        }
        else{
            field.setVal(value);
        }
		return true;
    } else {
		return false;
        //console.log("Failed to set field " + name);
    }
}
function getNamedFieldValue(currForm, name) {
    var [field, factor] = getNamedField(currForm, name);
    if (field) {
        if(factor){
            return field.val() * factor;
        }
        else{
            return field.val();
        }
        
    }
}

function exportCalculationData(currForm) {
    var resultObject = {};
    for (const[key, value]of Object.entries(CalculationMapping)) {
        var fieldValue = getNamedFieldValue(currForm, key);

        if (fieldValue != null) {
            resultObject[key] = fieldValue;
        }
    }

    return resultObject;
}

function importCalculationData(data, form, errorList) {
    for (const[key, value]of Object.entries(data)) {
		var success = setNamedFieldValue(form, key, value);
		if(!success){
			errorList.push(`Fehler beim Schreiben von ${key} auf ${value}!`);
		}
    }
}

</script>
