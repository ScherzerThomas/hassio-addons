 <script>
jQuery(function ($) {
    $(document).one(
        'showHideDepEvent',
        function () {
    });
});

jQuery(function ($) {
    $(document).ready(function () {
        console.log("init");
        var mk_grundmaschine = $('#fieldname80_1');
        var mk_maschine1 = $('#fieldname80_2');
        var mk_maschine2 = $('#fieldname80_3');
        var typ_grundmaschine_src = $('#fieldname96_1');
        var typ_maschine1_src = $('#fieldname96_2');
        var typ_maschine2_src = $('#fieldname96_3');

        var gk_grundmaschine = getField('fieldname8', '4');
        var gk_maschine1 = getField('fieldname9', '4');
        var gk_maschine2 = getField('fieldname10', '4');
        var typ_grundmaschine = getField('fieldname47', '4');
        var typ_maschine1 = getField('fieldname48', '4');
        var typ_maschine2 = getField('fieldname49', '4');

        var grundmaschineAct,
        maschine1Act,
        maschine2Act;

        mk_grundmaschine.change(function () {
            grundmaschineAct = mk_grundmaschine.val();
            console.log("Kosten der Grundmaschine geändert auf " + grundmaschineAct);
            gk_grundmaschine.setVal(grundmaschineAct);
        });

        mk_maschine1.change(function () {
            maschine1Act = mk_maschine1.val();
            console.log("Kosten der Maschine1 geändert auf " + maschine1Act);
            gk_maschine1.setVal(maschine1Act);
        });

        mk_maschine2.change(function () {
            maschine2Act = mk_maschine2.val();
            console.log("Kosten der Maschine2 geändert auf " + maschine2Act);
            gk_maschine2.setVal(maschine2Act);
        });

        typ_grundmaschine_src.change(function () {
            typ_grundmaschine.setVal(typ_grundmaschine_src.val())
        });
        typ_maschine1_src.change(function () {
            typ_maschine1.setVal(typ_maschine1_src.val())
        });
        typ_maschine2_src.change(function () {
            typ_maschine2.setVal(typ_maschine2_src.val())
        });
    });
});

currentFileVersion = 2;

function formatDate(date) {  
  if (!(date instanceof Date)) {
    throw new Error('Invalid "date" argument. You must pass a date instance')
  }

  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')

  return `${year}-${month}-${day}`;
}

function download(content, fileName, contentType) {
    const a = document.createElement("a");
    const file = new Blob([content], {
        type: contentType
    });
    a.href = URL.createObjectURL(file);
    a.download = fileName;
    a.click();
}

function collectData(){
    var formGrundmaschine = document.getElementById('cp_calculatedfieldsf_pform_1');
    var formMaschine1 = document.getElementById('cp_calculatedfieldsf_pform_2');
    var formMaschine2 = document.getElementById('cp_calculatedfieldsf_pform_3');
    var formKalkulation = document.getElementById('cp_calculatedfieldsf_pform_4');

    var grundmaschineData = exportMachineData(formGrundmaschine);
    var maschine1Data = exportMachineData(formMaschine1);
    var maschine2Data = exportMachineData(formMaschine2);
    var kalkulationData = exportCalculationData(formKalkulation);
    var machineName = grundmaschineData["Name"];
	machineName = machineName.replace(/[/\\?%*:|"<>]/g, '_');

    var data = {};
    data["GM"] = grundmaschineData;
    data["M1"] = maschine1Data;
    data["M2"] = maschine2Data;
    data["GK"] = kalkulationData;
    data["version"] = currentFileVersion;
    return [data, machineName];
}
function exportAllData() {
    console.log("export started");
    var [data, machineName] = collectData();
    console.log(machineName, data);

	var now = new Date();
	var fileName = `online-kalkulator.at_${machineName}_${formatDate(now)}.json`;
    download(JSON.stringify(data, undefined, 2), fileName, "text/plain");
}
function exportZip() {
    console.log("export started");
    var [data, machineName] = collectData();
    console.log(machineName, data);

	var now = new Date();
	var fileName = `online-kalkulator.at_${machineName}_${formatDate(now)}.json`;
    download(JSON.stringify(data, undefined, 2), fileName, "text/plain");
}

function importAllData(data, errorList) {
    console.log("data import started");
    var formGrundmaschine = document.getElementById('cp_calculatedfieldsf_pform_1');
    var formMaschine1 = document.getElementById('cp_calculatedfieldsf_pform_2');
    var formMaschine2 = document.getElementById('cp_calculatedfieldsf_pform_3');
    var formKalkulation = document.getElementById('cp_calculatedfieldsf_pform_4');


    if (data) {
        var version = data["version"];
        var grundmaschineData = data["GM"];
        var maschine1Data = data["M1"];
        var maschine2Data = data["M2"];
        var kalkulationData = data["GK"];

        if(version !== currentFileVersion){
            errorList.push("Berechnung hat sich seit dem letzten Mal geändert!");
            errorList.push("Bitte alle Felder kontrollieren!")
        }
        importMachineData(grundmaschineData, formGrundmaschine, errorList);
        importMachineData(maschine1Data, formMaschine1, errorList);
        importMachineData(maschine2Data, formMaschine2, errorList);
        importCalculationData(kalkulationData, formKalkulation, errorList);
        
        console.log("import finished!");
    } else {
		errorList.push("JSON Object ist leer!");
        console.error("JSON Object is leer!");
    }
}

function startDataImportByFile() {
    document.getElementById('loadFile').click();
}

function importDataByFile(e) {
	var errorList = []; //create error list
	
    var file = e.target.files[0];
    if (!file){
		errorList.push("No file selected!");
        return;
	}
    var reader = new FileReader();
    reader.onload = function (e) {
		try{
			var content = e.target.result;
			if(content.length < 100000) //valid files are usually much smaller than 100kB
			{
				var deserializedContent = JSON.parse(content);
				importAllData(deserializedContent, errorList);
			}
			else
			{
				//abort import
				errorList.push("Datei ist ungültig / zu groß!");
			}
		}
		catch (error) {
			errorList.push("Fehler: " + error.toString());
			console.error(error);
		}
		finally{
			var statusElement = document.getElementById('statusText');
			if(errorList.length > 0)
			{
				errorList.unshift(""); //Add empty line
				errorList.unshift("Achtung: Daten können unvollständig sein!"); //add warning for user
				statusElement.removeAttribute("hidden");
				statusElement.innerHTML = errorList.join('\r\n');
			}
			else
			{
				statusElement.removeAttribute("hidden");
				statusElement.innerHTML = "Import erfolgreich";
			}
		}
    }
    reader.readAsText(file);
}


async function createReport() {
    const spinner = document.getElementById('spinnerOverlay');
    const resultDiv = document.getElementById('resultButtons');
    
    // 1. Show Spinner
    spinner.style.display = 'block';
    resultDiv.style.display = 'none';

    try {
        // Collect your data (your existing logic)
        var [payload, machineName] = collectData();

        var requestedFileName = `Kalkulation_${machineName}_${formatDate(new Date())}`;

        // URLSearchParams kodiert Sonderzeichen automatisch
        const params = new URLSearchParams({ filename: requestedFileName });

        // Append the filename as a query parameter (?filename=...)
        const _0x4a21 = "aHR0cHM6Ly9hcGktb25saW5lLWthbmt1bGF0b3IuZHVja2Rucy5vcmcvZ2VuZXJhdGUtZXhjZWwtcGRm";
        const baseUrl = "https://api-online-kalkulator.duckdns.org/generate-excel-pdf"//atob(_0x4a21);
        const url = `${baseUrl}?${params.toString()}`;

        const response = await fetch(url, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                //'X-API-KEY': 'dein_shared_secret' // Security check
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error('API Fehler');


        //Parse the filename from the header
        const contentDisposition = response.headers.get('Content-Disposition');
        let fileName = `${requestedFileName}.zip`; // Fallback
        if (contentDisposition && contentDisposition.includes('filename=')) {
            // Basic extraction logic
            fileName = contentDisposition
                .split('filename=')[1]
                .split(';')[0]
                .replace(/"/g, ''); // Remove quotes if present
        }

        // 2. Process ZIP Response
        const blob = await response.blob();
        const zip = await JSZip.loadAsync(blob);

        // 1. Setup Individual Buttons (Extract from ZIP)
        setupIndividualDownload('pdfBtn', zip, fileName.replace(/\.zip$/i, ".pdf"), "application/pdf");
        setupIndividualDownload('excelBtn', zip, fileName.replace(/\.zip$/i, ".xlsx"), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");

        // 2. Setup "Everything as ZIP" Button (Direct use of Response Blob)
        const zipBtn = document.getElementById('zipBtn');
        zipBtn.onclick = () => {
            const url = URL.createObjectURL(zipBlob);
            triggerDownload(url, fileName);
        };

        // 4. Show Result UI
        resultDiv.style.display = 'block';

    } catch (error) {
        console.error(error);
        alert("Fehler beim Export: " + error.message);
    } finally {
        // 5. Hide Spinner
        spinner.style.display = 'none';
    }
}

function setupIndividualDownload(btnId, zip, fileName, mimeType) {
    const btn = document.getElementById(btnId);
    btn.onclick = async () => {
        const file = zip.file(fileName);
        if (!file) return alert("Datei nicht im ZIP gefunden.");
        
        const content = await file.async("blob");
        const url = URL.createObjectURL(new Blob([content], { type: mimeType }));
        triggerDownload(url, fileName);
    };
}

function triggerDownload(url, fileName) {
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 100);
}

</script>
