#!/usr/bin/with-contenv sh

# 30-mariadb-users
# Initializes MariaDB using passwords provided in HA add-on config.

set -e

DB_NAME="wordpress"
DB_ROOT_PASSWORD=$(bashio::config 'db_root_password')
DB_USER=$(bashio::config 'db_user')
DB_USER_PASSWORD=$(bashio::config 'db_user_password')

if [ -z "$DB_ROOT_PASSWORD" ] || [ -z "$DB_USER_PASSWORD" ]; then
    echo "[30-mariadb-users] ERROR: Please set db_root_password and db_user_password in add-on options."
    exit 1
fi

echo "[30-mariadb-users] Waiting for MariaDB to be ready..."

# Wait for MariaDB
for i in $(seq 1 30); do
    if mysqladmin ping --silent; then
        break
    fi
    sleep 1
done

if ! mysqladmin ping --silent; then
    echo "[30-mariadb-users] ERROR: MariaDB did not become ready."
    exit 1
fi

echo "[30-mariadb-users] MariaDB is up. Configuring users..."

# Set root password (safe if already set)
mysql -u root <<EOF || true
ALTER USER 'root'@'localhost' IDENTIFIED BY '${DB_ROOT_PASSWORD}';
FLUSH PRIVILEGES;
EOF

MYSQL_ROOT="mysql -u root -p${DB_ROOT_PASSWORD}"

# Create DB
$MYSQL_ROOT <<EOF
CREATE DATABASE IF NOT EXISTS \`${DB_NAME}\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EOF

# Create user + grant privileges
$MYSQL_ROOT <<EOF
CREATE USER IF NOT EXISTS '${DB_USER}'@'%' IDENTIFIED BY '${DB_USER_PASSWORD}';
GRANT ALL PRIVILEGES ON \`${DB_NAME}\`.* TO '${DB_USER}'@'%';
FLUSH PRIVILEGES;
EOF

echo "[30-mariadb-users] Database and user configured successfully."
